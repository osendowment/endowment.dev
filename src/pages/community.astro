---
// © Vlad-Stefan Harbuz <vlad@vlad.website>
// SPDX-License-Identifier: Apache-2.0

import Layout from '../layouts/Layout.astro';
import DonorMiniProfile from "../components/DonorMiniProfile.astro";
import { fetchDonors } from '../lib/api.ts';

const stats = await fetch('https://data.endowment.dev/api/public/stats').then(r => r.json());
const allDonors = await fetchDonors('https://data.endowment.dev/api/public/donors');
const individualDonors = allDonors.filter((d) => d.type == 'person');
const orgDonors = allDonors.filter((d) => d.type == 'organization');
const donorsByClass = individualDonors.reduce((donorsByClass, donor) => {
    if (!(donor.class in donorsByClass)) {
        donorsByClass[donor.class] = [];
    }
    donorsByClass[donor.class].push(donor);
    return donorsByClass;
}, {});
const nDonors = stats.donors.total;

const classDisplayNames: Record<string, string> = {
    '100K+': '$100,000+ individual donors',
    '10-100K': '$10,000+ individual donors',
    '1-10K': '$1,000+ individual donors',
    '0-1K': 'Other donors',
};
const otherDonorsClassName = '0-1K';
---

<Layout title="Community & Donors — Open Source Endowment" description="Meet the donors and community members supporting the Open Source Endowment's mission to provide sustainable funding for critical open source software." breadcrumbs={[{name: "Home", url: "https://endowment.dev/"}, {name: "Community", url: "https://endowment.dev/community/"}]}>
    <script type="application/ld+json" set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "Open Source Endowment Foundation",
        "url": "https://endowment.dev/",
        "founder": individualDonors
            .filter((d) => d.class !== '0-1K')
            .map((d) => ({
                "@type": "Person",
                "name": d.name,
                ...(d.github_url ? { "url": d.github_url } : d.linkedin_url ? { "url": d.linkedin_url } : {})
            }))
    })} />
    <article>
        <section class="pagesec pagesec--dark pagesec--tight">
            <div class="container">
                <div class="insec insec--xpad insec--ytight insec--side-squares insec--side-squares-blue">
                    <div class="community-intro">
                        <div class="sechead sechead--min-height sechead--left">
                            <h1>Community</h1>
                            <p>
                                We thank our {nDonors} donors for generous
                                contributions to the Open Source Endowment, and
                                encourage everybody to join them. Together, we
                                improve the sustainability of the world's software
                                supply chain.
                            </p>
                            <p>
                                Community is a cornerstone of our endowment, and
                                all individuals contributing at least $1000/year —
                                OSE Members — are invited to participate in its
                                <a href="/endowment#governance">governance</a>.
                            </p>
                        </div>
                        <div class="community-kpi">
                            <b>{stats.donors.members}</b>
                            <span>OSE members</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section class="pagesec">
            <div class="container">
                <div class="insec insec--xpad donor-board">
                    {Object.entries(donorsByClass).map(([className, donors]) =>
                        className != otherDonorsClassName && (
                            <h2>{classDisplayNames[className]} <span class="donor-count">{donors.length}</span></h2>
                            <div class="donor-list">
                                {donors.map((donor) => (
                                    <DonorMiniProfile
                                        name={donor.name}
                                        description={donor.description}
                                        avatarUrl={donor.picture_url}
                                        hasPhoto={true}
                                    ></DonorMiniProfile>
                                ))}
                            </div>
                        )
                    )}
                    <h2>Institutional donors <span class="donor-count">{orgDonors.length}</span></h2>
                    <div class="donor-list">
                        {orgDonors.map((donor) => (
                            <DonorMiniProfile
                                name={donor.name}
                                description={donor.description}
                                avatarUrl={donor.picture_url}
                                hasPhoto={true}
                            ></DonorMiniProfile>
                        ))}
                    </div>
                    <h2>{classDisplayNames[otherDonorsClassName]} <span class="donor-count">{donorsByClass[otherDonorsClassName]?.length ?? 0}</span></h2>
                    <div class="donor-list">
                        {(donorsByClass[otherDonorsClassName] ?? []).map((donor) => (
                            <DonorMiniProfile
                                name={donor.name}
                                compact={true}
                            ></DonorMiniProfile>
                        ))}
                    </div>
                </div>
            </div>
        </section>
    </article>
</Layout>

<style>
    .insec--side-squares-blue {
        &:before, &:after {
            background-image: url(/images/decorations/squares-side-blue.svg) !important;
        }
    }
    .donor-count {
        font-family: var(--font-family-mono);
        font-size: 0.35em;
        font-weight: 300;
        color: #bbb;
        vertical-align: baseline;
        margin-left: 0.4em;
        position: relative;
        top: -0.2em;
    }
    .community-intro {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4rem;
        @media (max-width: 800px) {
            flex-direction: column;
            align-items: center;
        }
        .sechead {
            max-width: 40rem;
        }
        .community-kpi {
            margin-top: 0;
            text-align: center;
            @media (max-width: 800px) {
                margin-top: 0;
            }
            b {
                display: block;
                margin-bottom: 1.0rem;
                font-size: var(--font-size-8);
                font-weight: normal;
                line-height: 1;
                @media (max-width: 800px) {
                    margin-bottom: 0.5rem;
                    font-size: var(--font-size-6);
                }
            }
        }
    }
</style>
