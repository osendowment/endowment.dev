---
// © Vlad-Stefan Harbuz <vlad@vlad.website>
// SPDX-License-Identifier: Apache-2.0

interface Props {
  title?: string;
  description?: string;
  nodonate?: boolean;
  noindex?: boolean;
  breadcrumbs?: Array<{name: string, url: string}>;
}

const {
  title = 'Open Source Endowment',
  description = 'Truly sustainable funding for critical open source software through a community\u2011driven endowment.',
  nodonate,
  noindex,
  breadcrumbs,
} = Astro.props;

import { EVERYORG_BUTTON_URL } from '../util.ts';
import '../styles/common.css';

import { OpenPanelComponent } from '@openpanel/astro';
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="/images/logo/web/favicon.png">
        <link rel="apple-touch-icon" href="/images/logo/web/apple-touch-icon.png">

        <link rel="preconnect" href="https://stats.endowment.dev">

        {Astro.url.pathname === '/' && <link rel="preload" fetchpriority="high" as="image" href="/images/branches.svg" type="image/svg+xml">}
        <link rel="preload" as="font" href="/fonts/ovo-normal-latin.woff2" type="font/woff2" crossorigin>
        <link rel="preload" as="font" href="/fonts/plus-jakarta-sans-200-800-normal-latin.woff2" type="font/woff2" crossorigin>
        <link rel="preload" as="font" href="/fonts/GeistMono[wght].woff2" type="font/woff2" crossorigin>

        {noindex && <meta name="robots" content="noindex, nofollow" />}

        <title>{title}</title>
        <meta
          name="description"
          content={description}>
        <link rel="canonical" href={Astro.url}>
        <link rel="me" href="https://x.com/osendowment">
        <link rel="me" href="https://www.linkedin.com/company/osendowment/">
        <link rel="me" href="https://github.com/osendowment">
        <meta property="og:type" content="website">
        <meta property="og:title" content={title}>
        <meta
          property="og:description"
          content={description}>
        <meta
          property="og:image"
          content="https://endowment.dev/images/opengraph.png">
        <meta
          property="og:image:alt"
          content="Truly sustainable funding for critical open source software.">
        <meta property="og:site_name" content="Open Source Endowment">
        <meta property="og:locale" content="en_US">
        <meta property="og:determiner" content="the">
        <meta property="og:url" content={Astro.url}>
        <meta
          name="twitter:title"
          content={title}>
        <meta
          name="twitter:description"
          content={description}>
        <meta
          name="twitter:image"
          content="https://endowment.dev/images/opengraph.png">
        <meta
          name="twitter:image:alt"
          content="Truly sustainable funding for critical open source software.">
        <meta name="twitter:url" content={Astro.url}>
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:site" content="@osendowment">

        <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": ["Organization", "NGO"],
          "name": "Open Source Endowment Foundation",
          "alternateName": "OSE",
          "url": "https://endowment.dev/",
          "logo": "https://endowment.dev/images/logo/Logomark%20Colored%20for%20Dark%20BG.png",
          "foundingDate": "2025-02-14",
          "foundingLocation": {
            "@type": "Place",
            "name": "Wilmington, Delaware, USA"
          },
          "founder": {
            "@type": "Person",
            "name": "Konstantin Vinogradov",
            "url": "https://www.linkedin.com/in/kvinogradov/"
          },
          "nonprofitStatus": "Nonprofit501c3",
          "taxID": "33-3502715",
          "address": {
            "@type": "PostalAddress",
            "streetAddress": "74 E Glenwood Ave Unit 5756",
            "addressLocality": "Smyrna",
            "addressRegion": "DE",
            "postalCode": "19977",
            "addressCountry": "US"
          },
          "areaServed": "Global",
          "sameAs": [
            "https://github.com/osendowment",
            "https://www.linkedin.com/company/osendowment/",
            "https://x.com/osendowment",
            "https://www.guidestar.org/profile/33-3502715"
          ],
          "description": "Tax-exempt 501(c)(3) US public charity providing truly sustainable funding for critical open source software through a community-driven endowment."
        }
        </script>

        <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "WebSite",
          "name": "Open Source Endowment",
          "url": "https://endowment.dev/",
          "description": "Truly sustainable funding for critical open source software through a community-driven endowment."
        }
        </script>

        {breadcrumbs && breadcrumbs.length > 0 && (
          <script type="application/ld+json" set:html={JSON.stringify({
            "@context": "https://schema.org",
            "@type": "BreadcrumbList",
            "itemListElement": breadcrumbs.map((crumb, i) => ({
              "@type": "ListItem",
              "position": i + 1,
              "name": crumb.name,
              "item": crumb.url
            }))
          })} />
        )}

        <link rel="alternate" type="text/plain" href="/llms.txt" title="LLM-friendly site summary">
        <link rel="alternate" type="text/plain" href="/llms-full.txt" title="LLM-friendly extended reference">

        <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

        <OpenPanelComponent
            clientId="56442bc4-68fa-4003-8935-8210f125f448"
            trackScreenViews={true}
            trackAttributes={true}
            trackOutgoingLinks={true} />
    </head>
    <body>
        <div class="header-and-nav">
            <header>
                <div class="container header-items">
                    <a href="/" class="logo">
                        <img
                            class="desktop-only"
                            src="/images/logo/OSE Logo.svg"
                            alt="The Open Source Endowment logo"
                            width="195" height="60">
                        <img
                            class="mobile-only"
                            src="/images/logo/Logomark Colored.svg"
                            alt="The Open Source Endowment logo"
                            width="140" height="140">
                    </a>
                    <div class="desktop-only">
                        <nav class="desktop-nav">
                            <a href="/endowment" class={Astro.url.pathname === '/endowment' ? 'active' : ''}>Endowment</a>
                            <a href="/community" class={Astro.url.pathname === '/community' ? 'active' : ''}>Community</a>
                            <a href="/docs" class={Astro.url.pathname === '/docs' ? 'active' : ''}>Docs</a>
                            <a href="/funding" class={Astro.url.pathname === '/funding' ? 'active' : ''}>Funding</a>
                            <a href="/faq" class={Astro.url.pathname === '/faq' ? 'active' : ''}>FAQ</a>
                        </nav>
                    </div>
                    <div class="desktop-only">
                        <div class="desktop-secondary-nav">
                            <a href="https://github.com/osendowment/foundation" target="_blank">
                                <svg role="img" aria-label="The GitHub logo" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 33 32"><path fill="#6b7280" fill-rule="evenodd" d="M16.288 0C7.294 0 0 7.293 0 16.29c0 7.197 4.667 13.302 11.14 15.456.815.15 1.112-.353 1.112-.785 0-.386-.014-1.411-.022-2.77-4.531.984-5.487-2.184-5.487-2.184-.741-1.882-1.809-2.383-1.809-2.383-1.479-1.01.112-.99.112-.99 1.635.115 2.495 1.679 2.495 1.679 1.453 2.489 3.813 1.77 4.741 1.353.148-1.052.569-1.77 1.034-2.177-3.617-.411-7.42-1.809-7.42-8.051 0-1.778.635-3.233 1.677-4.371-.168-.412-.727-2.069.16-4.311 0 0 1.367-.438 4.479 1.67a15.6 15.6 0 0 1 4.078-.549 15.6 15.6 0 0 1 4.078.549c3.11-2.108 4.475-1.67 4.475-1.67.889 2.242.33 3.899.163 4.311 1.044 1.138 1.674 2.593 1.674 4.371 0 6.258-3.809 7.635-7.437 8.038.584.503 1.105 1.497 1.105 3.017 0 2.177-.02 3.934-.02 4.468 0 .436.294.943 1.12.784 6.468-2.159 11.131-8.26 11.131-15.455C32.579 7.293 25.285 0 16.288 0"/></svg>
                            </a>
                            <a
                                href={EVERYORG_BUTTON_URL}
                                class="button button--colored button--small"
                                data-track="header-donate"
                            >Donate</a>
                        </div>
                    </div>
                    <div class="mobile-only">
                        <div class="header-buttons">
                            <button class="button button--icon-only hamburger-button nav-trigger" aria-expanded="false" aria-label="Toggle navigation menu">
                                <img src="/images/icons/em-hamburger.svg" alt="Menu" width="20" height="20">
                            </button>
                        </div>
                    </div>
                </div>
            </header>
            <div class="mobile-nav-wrapper">
                <div class="container">
                    <div class="mobile-only">
                        <nav class="mobile-nav" hidden>
                            <a href="/endowment" class={Astro.url.pathname === '/endowment' ? 'active' : ''}>Endowment</a>
                            <a href="/community" class={Astro.url.pathname === '/community' ? 'active' : ''}>Community</a>
                            <a href="/docs" class={Astro.url.pathname === '/docs' ? 'active' : ''}>Docs</a>
                            <a href="/funding" class={Astro.url.pathname === '/funding' ? 'active' : ''}>Funding</a>
                            <a href="/faq" class={Astro.url.pathname === '/faq' ? 'active' : ''}>FAQ</a>
                            <a
                                href={EVERYORG_BUTTON_URL}
                                class="button button--colored"
                                data-track="header-donate"
                            >Donate</a>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
        <main>
            <slot />
        </main>
        <footer>
            <div class="container footer-items">
                <div class="footer-brand">
                    <img
                        src="/images/logo/OSE Logo.svg"
                        alt="The Open Source Endowment logo"
                        width="195" height="60">
                    <p class="footer-credit">Designed by <a href="https://evilmartians.com/" target="_blank">Evil Martians</a></p>
                </div>
                <div class="footer-socials">
                    <a href="https://github.com/osendowment/foundation" target="_blank">
                        <svg role="img" aria-label="The GitHub logo" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 33 32"><path fill="#fff" fill-rule="evenodd" d="M16.288 0C7.294 0 0 7.293 0 16.29c0 7.197 4.667 13.302 11.14 15.456.815.15 1.112-.353 1.112-.785 0-.386-.014-1.411-.022-2.77-4.531.984-5.487-2.184-5.487-2.184-.741-1.882-1.809-2.383-1.809-2.383-1.479-1.01.112-.99.112-.99 1.635.115 2.495 1.679 2.495 1.679 1.453 2.489 3.813 1.77 4.741 1.353.148-1.052.569-1.77 1.034-2.177-3.617-.411-7.42-1.809-7.42-8.051 0-1.778.635-3.233 1.677-4.371-.168-.412-.727-2.069.16-4.311 0 0 1.367-.438 4.479 1.67a15.6 15.6 0 0 1 4.078-.549 15.6 15.6 0 0 1 4.078.549c3.11-2.108 4.475-1.67 4.475-1.67.889 2.242.33 3.899.163 4.311 1.044 1.138 1.674 2.593 1.674 4.371 0 6.258-3.809 7.635-7.437 8.038.584.503 1.105 1.497 1.105 3.017 0 2.177-.02 3.934-.02 4.468 0 .436.294.943 1.12.784 6.468-2.159 11.131-8.26 11.131-15.455C32.579 7.293 25.285 0 16.288 0"/></svg>
                        <span>osendowment</span>
                    </a>
                    <a href="https://www.linkedin.com/company/osendowment/" target="_blank">
                        <svg role="img" aria-label="The LinkedIn logo" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 72 72"><path fill="#fff" d="M8 0a8 8 0 0 0-8 8v56a8 8 0 0 0 8 8h56a8 8 0 0 0 8-8V8a8 8 0 0 0-8-8zm8.35 10c3.508 0 6.347 2.863 6.347 6.396s-2.84 6.399-6.347 6.399S10 19.929 10 16.396 12.842 10 16.35 10m33.033 16.273c7.353 0 12.617 4.49 12.617 13.778V62H51.316V43.803c0-4.99-1.896-7.778-5.845-7.778-4.296 0-6.54 2.902-6.54 7.778V62H28.634V27.332H38.93v4.672s3.096-5.73 10.453-5.73m-38.35 1.059h10.735V62H11.03z"></svg>
                        <span>osendowment</span>
                    </a>
                    <a href="https://x.com/osendowment" target="_blank">
                        <svg role="img" aria-label="The X (Twitter) logo" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 300 300.251"><path fill="#fff" d="M178.57 127.15 290.27 0h-26.46l-97.03 110.38L89.34 0H0l117.13 166.93L0 300.25h26.46l102.4-116.59 81.8 116.59H300M36.01 19.54h40.65l187.13 262.13h-40.66"/></svg>
                        <span>@osendowment</span>
                    </a>
                </div>
                <nav class="footer-nav">
                    <ul>
                        <li><a href="/endowment">Endowment</a></li>
                        <li><a href="/community">Community</a></li>
                        <li><a href="/docs">Docs</a></li>
                    </ul>
                    <ul>
                        <li><a href="/funding">Funding</a></li>
                        <li><a href="/faq">FAQ</a></li>
                        <li><a href={EVERYORG_BUTTON_URL}>Donate</a></li>
                    </ul>
                </nav>
                <div class="footer-legal">
                    <p>Open Source Endowment Foundation</p>
                    <p>US 501(c)(3) tax-exempt charity (EIN 33-3502715)</p>
                    <p>Address: 74 E Glenwood Ave Unit 5756, Smyrna, DE</p>
                </div>
            </div>
        </footer>
    </body>
</html>

<script>
    function debounce_leading(func, timeout = 300){
        let timer;
        return (...args) => {
            if (!timer) {
                func.apply(this, args);
            }
            clearTimeout(timer);
            timer = setTimeout(() => {
                timer = undefined;
            }, timeout);
        };
    }
    const $navTriggers = document.querySelectorAll('.nav-trigger');
    const $mobileNavs = document.querySelectorAll('.mobile-nav');
    $navTriggers.forEach(($navTrigger) => {
        $navTrigger.addEventListener('click', debounce_leading(() => {
            $mobileNavs.forEach(($mobileNav) => {
                $mobileNav.hidden = !$mobileNav.hidden;
                if ($navTrigger.dataset.active) {
                    delete $navTrigger.dataset.active;
                    $navTrigger.setAttribute('aria-expanded', 'false');
                } else {
                    $navTrigger.dataset.active = 'true';
                    $navTrigger.setAttribute('aria-expanded', 'true');
                }
            });
        }));
    });

    // Lazy-load Every.org donate button script after page is idle
    if ('requestIdleCallback' in window) {
        requestIdleCallback(() => {
            const s = document.createElement('script');
            s.src = '/js/everyorg-endowment-button.js';
            document.head.appendChild(s);
        });
    } else {
        setTimeout(() => {
            const s = document.createElement('script');
            s.src = '/js/everyorg-endowment-button.js';
            document.head.appendChild(s);
        }, 2000);
    }

    // Track session-level metrics for donation attribution
    if (!sessionStorage.getItem('ose_start')) {
        sessionStorage.setItem('ose_start', String(Date.now()));
        sessionStorage.setItem('ose_entry', window.location.pathname);
    }

    // Persistent visitor ID — shared across donation links and nomination form
    function getVisitorId() {
        let id = localStorage.getItem('ose_visitor_id');
        if (!id) {
            id = crypto.randomUUID();
            localStorage.setItem('ose_visitor_id', id);
        }
        return id;
    }
    window.__oseVisitorId = getVisitorId();

    // Inject partner_donation_id into donate hrefs BEFORE the Every.org widget
    // loads — the widget reads params from href at init time and via MutationObserver
    function injectPartnerParams(link) {
        const href = link.getAttribute('href');
        if (href.includes('partner_donation_id')) return; // already injected
        const [base, hash] = href.split('#');
        const sep = base.includes('?') ? '&' : '?';
        link.setAttribute('href',
            base + sep + 'partner_donation_id=' + encodeURIComponent(window.__oseVisitorId)
            + (hash ? '#' + hash : ''));
    }
    document.querySelectorAll('a[href*="every.org/osendowment"]').forEach(injectPartnerParams);

    // On click: identify in OpenPanel + update href with fresh partner_metadata
    document.querySelectorAll('a[href*="every.org/osendowment"]').forEach((link) => {
        link.addEventListener('click', () => {
            if (window.op) {
                window.op.identify({ profileId: window.__oseVisitorId });
            }

            // Build partner_metadata with attribution context
            const urlParams = new URLSearchParams(window.location.search);
            const metadata = {
                source: link.getAttribute('data-track') || 'unknown',
                entry_page: sessionStorage.getItem('ose_entry') || window.location.pathname,
                exit_page: window.location.pathname,
                time_on_site: Math.round((Date.now() - Number(sessionStorage.getItem('ose_start') || Date.now())) / 1000),
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                locale: navigator.language,
                utm_source: urlParams.get('utm_source') || undefined,
                utm_medium: urlParams.get('utm_medium') || undefined,
                utm_campaign: urlParams.get('utm_campaign') || undefined,
                utm_content: urlParams.get('utm_content') || undefined,
            };
            const metadataB64 = btoa(JSON.stringify(metadata));

            // Update href with metadata — widget's MutationObserver picks this up
            const href = link.getAttribute('href');
            if (href.includes('partner_metadata=')) {
                link.setAttribute('href', href.replace(/partner_metadata=[^&#]*/, 'partner_metadata=' + encodeURIComponent(metadataB64)));
            } else {
                const [base, hash] = href.split('#');
                link.setAttribute('href',
                    base + '&partner_metadata=' + encodeURIComponent(metadataB64)
                    + (hash ? '#' + hash : ''));
            }
        });
    });

    // Auto-open donate form when URL has #donate
    if (window.location.hash === '#donate') {
        // Wait for Every.org script to load before clicking
        const tryOpen = () => {
            const donateLink = document.querySelector('a[data-track="header-donate"]');
            if (donateLink) donateLink.click();
        };
        setTimeout(tryOpen, 3000);
    }
</script>
